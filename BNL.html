<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Logistics Optimizer Pro</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFoZNk73X4CY1RG3xghjxbAPTnx0JXmO8&libraries=geometry"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --text-light: #64748b; --border: #e2e8f0; --accent: #10b981; }
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
body { background: var(--bg); color: var(--text); padding: 20px; }
.container { max-width: 1440px; margin: 0 auto; }
header { text-align: center; margin-bottom: 30px; }
header h1 { font-size: 2.2rem; font-weight: 800; color: #0f172a; }
.upload-area { display: grid; grid-template-columns: 1fr 350px; gap: 20px; margin-bottom: 30px; }
#dropZone { background: var(--card); border: 2px dashed var(--border); border-radius: 20px; padding: 40px; text-align: center; cursor: pointer; transition: 0.2s; }
#dropZone.active { border-color: var(--accent); background: #f0fdf4; }
.control-card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
.btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }
.btn:disabled { background: #cbd5e1; cursor: not-allowed; }
#resultsGrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }
.truck-card { background: var(--card); border-radius: 24px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
.truck-header { padding: 18px 24px; background: #0f172a; color: white; display: flex; justify-content: space-between; align-items: center; }
.map-view { height: 280px; background: #f1f5f9; width: 100%; border-bottom: 1px solid var(--border); }
.metrics { display: grid; grid-template-columns: 1fr 1fr; padding: 15px; background: #f8fafc; border-bottom: 1px solid var(--border); gap: 10px; }
.m-label { font-size: 0.65rem; text-transform: uppercase; color: var(--text-light); font-weight: 700; }
.m-val { font-size: 1.1rem; font-weight: 800; color: #0f172a; display: block; }
.stop-list { flex-grow: 1; max-height: 380px; overflow-y: auto; padding: 10px 0; }
.stop-card { padding: 12px 24px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
.stop-name { font-weight: 700; font-size: 0.9rem; color: #334155; }
.stop-trans { font-size: 0.75rem; color: var(--text-light); font-family: monospace; margin-top: 2px; }
.copy-footer { padding: 20px; background: #fff; border-top: 1px solid var(--border); }
.btn-copy { width: 100%; padding: 12px; background: #f8fafc; border: 1px solid var(--border); border-radius: 10px; font-size: 0.85rem; font-weight: 600; cursor: pointer; }
.btn-copy.success { background: var(--accent); color: white; }
#status { color: var(--text-light); font-size: 0.9rem; margin-top: 10px; }
</style>
</head>
<body>

<div class="container">
    <header><h1>Fleet Load Optimizer</h1><p>Balanced Stops, Volumes & Live Map Routing</p></header>
    <div class="upload-area">
        <div id="dropZone">
            <div style="font-size:1.5rem">ðŸ“„</div>
            <div style="font-weight:700">Drop Excel Logistics File</div>
            <div id="status">Waiting for file...</div>
        </div>
        <div class="control-card">
            <button class="btn" id="calcBtn" disabled>Generate Balanced Routes</button>
        </div>
    </div>
    <div id="resultsGrid"></div>
</div>

<script>
const START_LOC = "Snelliusstraat 12, Dordrecht";
const clientAddresses = {"SHI001":"Dordrecht Voltastraat 6A","FUJ001":"ROTTERDAM Kortenoord 2-8","NEK118":"Rotterdam Columbusstraat 22-26","MAA002":"HOOGVLIET Klompenmakerstraat 26","WRI001":"ROTTERDAM Bunschotenweg 58","RMS001":"Rotterdam Plompertstraat 50","GIM001":"Schiedam Jan Van Galenstraat 9","WRKL00":"ROTTERDAM Bunschotenweg 58","FUJWEB":"ROTTERDAM Kortenoord 2-8"};

let rawLocations = [];
const dropZone = document.getElementById("dropZone");
const calcBtn = document.getElementById("calcBtn");

dropZone.onclick = () => { let i = document.createElement("input"); i.type="file"; i.onchange=e=>handleFile(e.target.files[0]); i.click(); };
dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add("active"); };
dropZone.ondrop = e => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); };

function handleFile(file) {
    const r = new FileReader();
    r.onload = e => {
        const wb = XLSX.read(new Uint8Array(e.target.result), {type:"array"});
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1, defval:""});
        let hIdx = rows.findIndex(row => row.includes("Customer"));
        const heads = rows[hIdx];
        const data = rows.slice(hIdx + 1);
        const colMap = { cust: heads.indexOf("Customer"), trans: heads.indexOf("Transport no."), m3: heads.indexOf("Expected mtr3") };
        
        let groups = {};
        data.forEach(row => {
            const id = row[colMap.cust]; if(!id) return;
            const tNo = String(row[colMap.trans]);
            const vol = parseFloat(String(row[colMap.m3]).replace(",", ".")) || 0;
            if(!groups[id]) groups[id] = { id, items: [], totalVol: 0, addr: clientAddresses[id] || id };
            groups[id].items.push({ no: tNo, vol: vol });
            groups[id].totalVol += vol;
        });
        rawLocations = Object.values(groups);
        document.getElementById("status").innerText = `${rawLocations.length} locations loaded. Click calculate.`;
        calcBtn.disabled = false;
    };
    r.readAsArrayBuffer(file);
}

calcBtn.onclick = () => {
    let trucks = [{id:1, stops:[], vol:0}, {id:2, stops:[], vol:0}, {id:3, stops:[], vol:0}];
    
    // Sort customers by volume (highest first)
    let customers = [...rawLocations].sort((a,b) => b.totalVol - a.totalVol);

    customers.forEach(cust => {
        // Balance Logic: Find truck with lowest Load Factor (Mix of Vol + Stop Count)
        let target = trucks.reduce((prev, curr) => {
            let prevScore = (prev.vol / 21) + (prev.stops.length * 0.4);
            let currScore = (curr.vol / 21) + (curr.stops.length * 0.4);
            return currScore < prevScore ? curr : prev;
        });

        // Split Logic for massive orders (e.g. NEK118 > 21m3)
        if (target.vol + cust.totalVol > 21 || cust.totalVol > 21) {
            cust.items.forEach(item => {
                let emptiest = trucks.reduce((p, c) => c.vol < p.vol ? c : p);
                let existingStop = emptiest.stops.find(s => s.id === cust.id);
                if (existingStop) {
                    existingStop.items.push(item);
                    existingStop.currentVol += item.vol;
                } else {
                    emptiest.stops.push({ id: cust.id, addr: cust.addr, items: [item], currentVol: item.vol });
                }
                emptiest.vol += item.vol;
            });
        } else {
            target.stops.push({ id: cust.id, addr: cust.addr, items: [...cust.items], currentVol: cust.totalVol });
            target.vol += cust.totalVol;
        }
    });

    renderTrucks(trucks);
};

function renderTrucks(trucks) {
    const grid = document.getElementById("resultsGrid");
    grid.innerHTML = "";
    trucks.forEach(t => {
        const card = document.createElement("div");
        card.className = "truck-card";
        card.innerHTML = `
            <div class="truck-header"><h2>TRUCK ${t.id}</h2></div>
            <div id="map-${t.id}" class="map-view"></div>
            <div class="metrics">
                <div class="metric-box"><span class="m-label">Volume</span><span class="m-val">${t.vol.toFixed(2)} mÂ³</span></div>
                <div class="metric-box"><span class="m-label">Drop Count</span><span class="m-val">${t.stops.length}</span></div>
                <div class="metric-box"><span class="m-label">Distance</span><span class="m-val" id="dist-${t.id}">...</span></div>
                <div class="metric-box"><span class="m-label">Est. Time</span><span class="m-val" id="time-${t.id}">...</span></div>
            </div>
            <div class="stop-list">
                ${t.stops.map(s => `
                    <div class="stop-card">
                        <div>
                            <div class="stop-name">${s.id}</div>
                            <div class="stop-trans">Nos: ${s.items.map(i => i.no).join(", ")}</div>
                        </div>
                        <div style="font-weight:800; color:var(--primary)">${s.currentVol.toFixed(2)}</div>
                    </div>
                `).join("")}
            </div>
            <div class="copy-footer"><button class="btn-copy" id="btn-${t.id}" onclick="copyToClip(${t.id})">Copy Transport Nos</button></div>
        `;
        grid.appendChild(card);
    });

    window.currentSolution = trucks;
    
    // DELAY MAP INITIALIZATION to ensure elements exist in DOM
    setTimeout(() => {
        trucks.forEach(t => initTruckRoute(t));
    }, 500);
}

function initTruckRoute(t) {
    const mapEl = document.getElementById(`map-${t.id}`);
    if (!mapEl || typeof google === "undefined") return;

    const map = new google.maps.Map(mapEl, { zoom: 9, center: {lat: 51.81, lng: 4.67}, disableDefaultUI: true });
    const ds = new google.maps.DirectionsService();
    const dr = new google.maps.DirectionsRenderer({ map, suppressMarkers: false });

    const waypoints = t.stops.map(s => ({ location: s.addr, stopover: true }));

    if (waypoints.length > 0) {
        ds.route({
            origin: START_LOC,
            destination: START_LOC,
            waypoints: waypoints,
            optimizeWaypoints: true,
            travelMode: google.maps.TravelMode.DRIVING
        }, (result, status) => {
            if (status === "OK") {
                dr.setDirections(result);
                let totalDist = 0;
                let totalTime = 0;
                result.routes[0].legs.forEach(leg => {
                    totalDist += leg.distance.value;
                    totalTime += leg.duration.value;
                });
                document.getElementById(`dist-${t.id}`).innerText = (totalDist / 1000).toFixed(1) + " km";
                document.getElementById(`time-${t.id}`).innerText = Math.floor(totalTime / 3600) + "h " + Math.floor((totalTime % 3600) / 60) + "m";
            } else {
                document.getElementById(`dist-${t.id}`).innerText = "N/A";
                document.getElementById(`time-${t.id}`).innerText = "N/A";
            }
        });
    }
}

async function copyToClip(id) {
    const truck = window.currentSolution.find(x => x.id === id);
    const nos = truck.stops.flatMap(s => s.items.map(i => i.no)).join(";");
    await navigator.clipboard.writeText(nos);
    const btn = document.getElementById(`btn-${id}`);
    btn.innerText = "âœ“ Copied!"; btn.classList.add("success");
    setTimeout(() => { btn.innerText = "Copy Transport Nos"; btn.classList.remove("success"); }, 2000);
}
</script>
</body>
</html>