<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNL Optimizer</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFoZNk73X4CY1RG3xghjxbAPTnx0JXmO8&libraries=geometry"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --card: #ffffff; --text: #0f172a; --text-light: #64748b; --border: #cbd5e1; --success: #059669; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 25px; }
        .container { max-width: 1600px; margin: 0 auto; }
        header { margin-bottom: 30px; border-bottom: 2px solid var(--border); padding-bottom: 15px; }
        .upload-area { display: grid; grid-template-columns: 1fr 350px 350px; gap: 20px; margin-bottom: 30px; }
        #dropZone { background: var(--card); border: 3px dashed var(--border); border-radius: 24px; height: 180px; display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; transition: all 0.2s ease; }
        #dropZone:hover { border-color: var(--primary); background: #f8fafc; }
        .control-card, .summary-card { background: var(--card); padding: 25px; border-radius: 24px; border: 1px solid var(--border); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .summary-card { background: #0f172a; color: white; }
        .summary-card .m-label { color: #94a3b8; }
        .summary-card .m-val { color: white; font-size: 1.4rem; }
        .btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; font-size: 1rem; margin-bottom: 10px; }
        .btn-export { background: var(--success); }
        #resultsGrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }
        .truck-card { background: var(--card); border-radius: 28px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .truck-header { padding: 20px; background: #0f172a; color: white; font-weight: 800; font-size: 1.2rem; }
        .map-view { height: 300px; background: #e2e8f0; width: 100%; }
        .metrics { display: grid; grid-template-columns: repeat(2, 1fr); padding: 20px; background: #f8fafc; gap: 15px; border-bottom: 1px solid var(--border); }
        .m-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-light); font-weight: 800; display: block; }
        .m-val { font-size: 1.1rem; font-weight: 800; color: #0f172a; }
        .stop-list { flex-grow: 1; max-height: 400px; overflow-y: auto; }
        .stop-card { padding: 15px 20px; border-bottom: 1px solid #f1f5f9; }
        .tag { font-size: 0.65rem; background: #e0e7ff; color: #4338ca; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-right: 4px; }
        .btn-copy { width: calc(100% - 40px); margin: 20px; padding: 12px; background: #f1f5f9; border: 1px solid var(--border); border-radius: 10px; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <header><h1>BNL<span style="font-weight: 400; color: var(--text-light);">Optimizer</span></h1></header>
    <div class="upload-area">
        <div id="dropZone">
            <div style="font-size: 2.5rem; margin-bottom: 10px;">ðŸ“¦</div>
            <div id="status" style="font-weight: 700;">Upload Excel voor Planning</div>
        </div>
        <div class="control-card">
            <p style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 15px;">De "Super-Strategy" is nu actief. Alle criteria (Volume, Regio, Adres-Locking) worden automatisch gecombineerd.</p>
            <button class="btn" id="calcBtn" disabled>Bereken Optimale Planning</button>
            <button class="btn btn-export" id="exportBtn" style="display:none;" onclick="exportToPDF()">Download PDF Planning</button>
        </div>
        <div class="summary-card">
            <div style="margin-bottom: 20px;"><span class="m-label">Totaal Afstand</span><span class="m-val" id="total-dist">0.0 km</span></div>
            <div><span class="m-label">Totaal Reistijd</span><span class="m-val" id="total-time">0u 0m</span></div>
        </div>
    </div>
    <div id="resultsGrid"></div>
</div>

<script>
const WAREHOUSE = "Snelliusstraat 12, 3313LL Dordrecht, NL";
const MAX_VOL = 21.0;
const ADRES_MAPPING = {
    "SHI001": "Voltastraat 6A, Dordrecht, NL", "SHI038": "Voltastraat 6A, Dordrecht, NL",
    "FUJ001": "Kortenoord 2-8, Rotterdam, NL", "FUJ118": "Kortenoord 2-8, Rotterdam, NL", "FUJWEB": "Kortenoord 2-8, Rotterdam, NL",
    "ARN001": "Plompertstraat 18B, Rotterdam, NL", "RMS001": "Plompertstraat 50, Rotterdam, NL", "RMS118": "Plompertstraat 50, Rotterdam, NL",
    "GEO003": "van Maasdijkweg 56, Rotterdam, NL", "GEO118": "van Maasdijkweg 56, Rotterdam, NL", "EMD001": "Van Maasdijkweg 56, Rotterdam, NL",
    "VIV118": "Gieterijweg 17, Rotterdam, NL", "MAA002": "Klompenmakerstraat 26, Hoogvliet, NL", "MAA118": "Klompenmakerstraat 26, Hoogvliet, NL",
    "MAA120": "Klompenmakerstraat 26, Hoogvliet, NL", "MAA119": "Klompenmakerstraat 26, Hoogvliet, NL", "MAR118": "Tinnegieterstraat 15, Hoogvliet, NL",
    "MPA001": "Tinnegieterstraat 15, Hoogvliet, NL", "MAS005": "â€™s-Gravelandseweg 359, Schiedam, NL", "NOV001": "Lodewijk Pincoffsweg 438, Rotterdam, NL",
    "OUW001": "Tarwezand 2-20, Pernis, NL", "OUWWEB": "Tarwezand 2-20, Pernis, NL", "MSC001": "Columbusstraat 26-28, Rotterdam, NL",
    "NEK001": "Columbusstraat 22-26, Rotterdam, NL", "NEK118": "Columbusstraat 22-26, Rotterdam, NL", "NEK002": "Columbusstraat 22-26, Rotterdam, NL",
    "NEK003": "Columbusstraat 22-26, Rotterdam, NL", "INT025": "Columbusstraat 30a, Rotterdam, NL", "SUP002": "Columbusstraat 12, Rotterdam, NL",
    "SUP118": "Columbusstraat 12, Rotterdam, NL", "WRI001": "Bunschotenweg 58, Rotterdam, NL", "WRI04B": "Bunschotenweg 58, Rotterdam, NL",
    "WRI007": "Bunschotenweg 58, Rotterdam, NL", "WRKL00": "Bunschotenweg 58, Rotterdam, NL", "WRKL18": "Bunschotenweg 58, Rotterdam, NL",
    "VAN008": "Bunschotenweg 115, Rotterdam, NL", "TER118": "Seggelant-Noord 17, Vierpolders, NL", "TER001": "Seggelant-Noord 17, Vierpolders, NL", 
    "KLO118": "Rhoneweg 68, Rotterdam, NL", "KLO119": "Rhoneweg 68, Rotterdam, NL", "PEN001": "Kleidijk 88, Rhoon, NL", 
    "SCH018": "Van Hennaertweg 1, Alblasserdam, NL", "ROT003": "Transportweg 20, Barendrecht, NL", "MEE002": "Donk 15, Barendrecht, NL", 
    "MEE118": "Donk 15, Barendrecht, NL", "DIT002": "Bijdorp-Oost 14A, Barendrecht, NL", "MOS002": "FENNAWEG 24, Barendrecht, NL", 
    "HAR004": "Achterzeedijk 57, Barendrecht, NL", "HAR118": "Achterzeedijk 57, Barendrecht, NL", "GIL001": "Giessenweg 56, Rotterdam, NL", 
    "GIL118": "Giessenweg 56, Rotterdam, NL", "ADR002": "Admiraal de Ruyterstraat 16C, Schiedam, NL", "POS001": "Pittsburgstraat 33, Rotterdam, NL", 
    "PRI006": "Fokkerstraat 517, Schiedam, NL", "VER011": "Frans Halslaan 4, Bergschenhoek, NL", "GIM001": "Jan Van Galenstraat 9, Schiedam, NL", 
    "GIM118": "Jan Van Galenstraat 9, Schiedam, NL", "LIM001": "Strickledeweg 25, Schiedam, NL", "IST001": "Kotterstraat 2, Vlaardingen, NL", 
    "BRA001": "Columbusstraat 22-26, Rotterdam, NL", "BRA004": "Columbusstraat 22-26, Rotterdam, NL", "SEA013": "Hoekerstraat 19, Vlaardingen, NL", 
    "KOO004": "Westerhavenweg 14, Vlissingen, NL", "ROS002": "Rhoneweg 68, Europoort, NL", "KOO119": "Grenadierweg 19, Middelburg, NL", 
    "PRO006": "Westpoort 51, Zwijndrecht, NL", "PRO131": "Westpoort 51, Zwijndrecht, NL", "HUL001": "Bredastraat 139, Antwerpen, BE", 
    "DEL007": "Westpoort 51, Zwijndrecht, NL", "ELE001": "Ohmweg 14, Spijkenisse, NL", "ELEWEB": "Ohmweg 14, Spijkenisse, NL", 
    "FMVB01": "Curieweg 2, Spijkenisse, NL", "FMVB02": "Curieweg 2, Spijkenisse, NL"
};

let addressGroups = [];
let globalDistances = { 1:0, 2:0, 3:0 };
let globalTimes = { 1:0, 2:0, 3:0 };

const dropZone = document.getElementById("dropZone");
const calcBtn = document.getElementById("calcBtn");
const exportBtn = document.getElementById("exportBtn");

dropZone.onclick = () => { let i = document.createElement("input"); i.type="file"; i.onchange=e=>handleFile(e.target.files[0]); i.click(); };
dropZone.ondragover = e => e.preventDefault();
dropZone.ondrop = e => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); };

function handleFile(file) {
    const r = new FileReader();
    r.onload = e => {
        const dataArr = new Uint8Array(e.target.result);
        const wb = XLSX.read(dataArr, {type:"array"});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
        let hIdx = rows.findIndex(row => row.join('|').includes("Customer"));
        const heads = rows[hIdx];
        const col = { cust: heads.indexOf("Customer"), trans: heads.indexOf("Transport no."), m3: heads.indexOf("Expected mtr3") };
        
        let groups = {};
        rows.slice(hIdx + 1).forEach(row => {
            const custId = String(row[col.cust] || "").trim();
            if(!custId) return;
            const vol = parseFloat(String(row[col.m3]).replace(",", ".")) || 0;
            const addr = ADRES_MAPPING[custId] || custId;
            if(!groups[addr]) groups[addr] = { addr, customers: new Set(), items: [], totalVol: 0 };
            groups[addr].customers.add(custId);
            groups[addr].items.push({ no: row[col.trans], vol, cust: custId });
            groups[addr].totalVol += vol;
        });
        addressGroups = Object.values(groups);
        document.getElementById("status").innerText = addressGroups.length + " Unieke Locaties Klaar";
        calcBtn.disabled = false;
    };
    r.readAsArrayBuffer(file);
}

calcBtn.onclick = () => {
    let trucks = [{id:1, stops:[], vol:0}, {id:2, stops:[], vol:0}, {id:3, stops:[], vol:0}];
    
    // 1. Sort geographically by City then Volume
    let sorted = [...addressGroups].sort((a,b) => {
        let cityA = a.addr.split(',').reverse()[1] || "";
        let cityB = b.addr.split(',').reverse()[1] || "";
        return cityA.localeCompare(cityB) || b.totalVol - a.totalVol;
    });

    sorted.forEach(group => {
        // 2. UNIFIED LOGIC:
        // A. Is this address already in a truck? (Address Locking)
        let existingTruck = trucks.find(t => t.stops.some(s => s.addr === group.addr));
        
        let target;
        if (existingTruck && (existingTruck.vol + group.totalVol <= MAX_VOL + 0.5)) {
            target = existingTruck;
        } else {
            // B. Weighted Scoring (Proximity + Volume + Fairness)
            target = trucks.sort((a,b) => {
                let scoreA = (a.vol / MAX_VOL) * 2 + (a.stops.length / 10);
                let scoreB = (b.vol / MAX_VOL) * 2 + (b.stops.length / 10);
                return scoreA - scoreB;
            })[0];
        }

        // C. Split Handling
        if (group.totalVol > MAX_VOL || (target.vol + group.totalVol > MAX_VOL + 1)) {
            group.items.forEach(it => {
                let subTarget = trucks.sort((a,b) => a.vol - b.vol)[0];
                let s = subTarget.stops.find(x => x.addr === group.addr);
                if(s) { s.items.push(it); s.currentVol += it.vol; s.custs.add(it.cust); }
                else { subTarget.stops.push({ addr: group.addr, custs: new Set([it.cust]), items: [it], currentVol: it.vol }); }
                subTarget.vol += it.vol;
            });
        } else {
            target.stops.push({ addr: group.addr, custs: group.customers, items: group.items, currentVol: group.totalVol });
            target.vol += group.totalVol;
        }
    });

    render(trucks);
    exportBtn.style.display = 'block';
};

function render(trucks) {
    const grid = document.getElementById("resultsGrid");
    grid.innerHTML = "";
    trucks.forEach(t => {
        const card = document.createElement("div");
        card.className = "truck-card";
        card.innerHTML = `
            <div class="truck-header">Vrachtwagen ${t.id}</div>
            <div id="map-${t.id}" class="map-view"></div>
            <div class="metrics">
                <div><span class="m-label">Volume</span><span class="m-val">${t.vol.toFixed(2)} mÂ³</span></div>
                <div><span class="m-label">Stops</span><span class="m-val">${t.stops.length}</span></div>
                <div><span class="m-label">Afstand</span><span class="m-val" id="dist-${t.id}">...</span></div>
                <div><span class="m-label">Tijd</span><span class="m-val" id="time-${t.id}">...</span></div>
            </div>
            <div class="stop-list">
                ${t.stops.map(s => `
                    <div class="stop-card">
                        <b>${s.addr.split(',')[0]}</b><br>
                        <small>${s.addr.split(',')[1] || ''}</small><br>
                        <span style="color:var(--primary); font-weight:800">${s.currentVol.toFixed(2)} mÂ³</span>
                        <div style="margin-top:5px">${Array.from(s.custs).map(c => `<span class="tag">${c}</span>`).join("")}</div>
                    </div>
                `).join("")}
            </div>
            <button class="btn-copy" onclick="copyN(${t.id})">Kopieer TP Nrs</button>`;
        grid.appendChild(card);
        setTimeout(() => initM(t), 500);
    });
    window.final = trucks;
}

function initM(t) {
    const el = document.getElementById(`map-${t.id}`);
    if(!el || typeof google === "undefined" || t.stops.length === 0) return;
    const map = new google.maps.Map(el, { zoom: 10, center: {lat: 51.8, lng: 4.6}, disableDefaultUI: true });
    const ds = new google.maps.DirectionsService(), dr = new google.maps.DirectionsRenderer({ map });
    ds.route({ origin: WAREHOUSE, destination: WAREHOUSE, waypoints: t.stops.map(s => ({location: s.addr, stopover:true})), optimizeWaypoints: true, travelMode: 'DRIVING' }, (res, stat) => {
        if (stat === 'OK') {
            dr.setDirections(res);
            let d = 0, tt = 0; res.routes[0].legs.forEach(l => { d += l.distance.value; tt += l.duration.value; });
            globalDistances[t.id] = d; globalTimes[t.id] = tt; updateGlobalMetrics();
            document.getElementById(`dist-${t.id}`).innerText = (d/1000).toFixed(1) + " km";
            document.getElementById(`time-${t.id}`).innerText = Math.floor(tt/3600) + "u " + Math.floor((tt%3600)/60) + "m";
        }
    });
}

function updateGlobalMetrics() {
    const d = Object.values(globalDistances).reduce((a,b)=>a+b, 0);
    const t = Object.values(globalTimes).reduce((a,b)=>a+b, 0);
    document.getElementById("total-dist").innerText = (d/1000).toFixed(1) + " km";
    document.getElementById("total-time").innerText = Math.floor(t/3600) + "u " + Math.floor((t%3600)/60) + "m";
}

function copyN(id) {
    const t = window.final.find(x => x.id === id);
    const nos = t.stops.flatMap(s => s.items.map(i => i.no)).join(";");
    navigator.clipboard.writeText(nos);
    alert("TP Nummers gekopieerd!");
}

async function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    // PAGE 1: OVERVIEW
    doc.setFontSize(24);
    doc.setTextColor(37, 99, 235);
    doc.text("BNL Master Planning", 15, 30);
    doc.setFontSize(12);
    doc.setTextColor(0);
    doc.text(`Totaal Afstand: ${document.getElementById("total-dist").innerText}`, 15, 45);
    doc.text(`Totaal Tijd: ${document.getElementById("total-time").innerText}`, 15, 52);
    
    // TRUCK PAGES
    for (const t of window.final) {
        doc.addPage();
        doc.setFontSize(20);
        doc.text(`Vrachtwagen ${t.id}`, 15, 20);
        doc.setFontSize(10);
        doc.text(`Volume: ${t.vol.toFixed(2)} m3 | Afstand: ${document.getElementById(`dist-${t.id}`).innerText}`, 15, 28);
        
        const canvas = await html2canvas(document.getElementById(`map-${t.id}`), { useCORS: true, scale: 2 });
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 15, 35, 180, 80);
        
        let y = 125;
        t.stops.forEach((s, idx) => {
            if (y > 275) { doc.addPage(); y = 20; }
            doc.setFont(undefined, 'bold');
            doc.text(`${idx+1}. ${s.addr.split(',')[0]} - ${s.currentVol.toFixed(2)} m3`, 15, y);
            doc.setFont(undefined, 'normal');
            doc.text(`TP: ${s.items.map(i=>i.no).join(", ")}`, 15, y+5);
            y += 12;
        });
    }
    doc.save("BNL_Planning.pdf");
}
</script>
</body>
</html>