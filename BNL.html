<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fair-Driver Logistics Optimizer</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFoZNk73X4CY1RG3xghjxbAPTnx0JXmO8&libraries=geometry"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --text-light: #64748b; --border: #e2e8f0; --accent: #10b981; }
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
body { background: var(--bg); color: var(--text); padding: 20px; }
header { text-align: center; margin-bottom: 30px; }
header h1 { font-size: 2rem; font-weight: 800; color: #0f172a; }
.top-bar { display: grid; grid-template-columns: 1fr 380px; gap: 20px; margin-bottom: 30px; }
#dropZone { background: var(--card); border: 2px dashed var(--border); border-radius: 16px; padding: 40px; text-align: center; cursor: pointer; transition: 0.2s; }
#dropZone.active { border-color: var(--accent); background: #f0fdf4; }
.config-card { background: var(--card); padding: 25px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
.btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; }
.btn:disabled { background: #cbd5e1; cursor: not-allowed; }
#results { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
.truck-card { background: var(--card); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
.t-header { padding: 15px 20px; background: #0f172a; color: white; display: flex; justify-content: space-between; }
.map-box { height: 280px; background: #e2e8f0; }
.stats { display: grid; grid-template-columns: repeat(2, 1fr); padding: 15px; background: #f8fafc; border-bottom: 1px solid var(--border); gap: 10px; }
.s-label { font-size: 0.65rem; text-transform: uppercase; color: var(--text-light); font-weight: 700; }
.s-val { font-size: 1rem; font-weight: 800; color: #0f172a; display: block; }
.stop-list { flex-grow: 1; max-height: 350px; overflow-y: auto; }
.stop-item { padding: 10px 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
.stop-name { font-weight: 700; font-size: 0.85rem; }
.copy-area { padding: 15px; background: #fff; border-top: 1px solid var(--border); }
.btn-copy { width: 100%; padding: 10px; background: #f1f5f9; border: 1px solid var(--border); border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; }
.btn-copy.success { background: var(--accent); color: white; }
</style>
</head>
<body>

<div class="container">
    <header><h1>Fair Driver Route Optimizer</h1><p>Balanced Volume • Geographic Integrity • Zero Conflicts</p></header>
    <div class="top-bar">
        <div id="dropZone">
            <div style="font-weight:700">Drop Excel Logistics File</div>
            <div id="status" style="font-size:0.9rem;color:var(--text-light);margin-top:8px">Waiting for data...</div>
        </div>
        <div class="config-card">
            <label style="font-size:0.7rem;font-weight:800;color:var(--text-light);text-transform:uppercase">Optimizer Priority</label>
            <div style="font-weight:600;margin:5px 0 20px">Fair Workload (Time & Volume)</div>
            <button class="btn" id="calcBtn" disabled>Calculate Fair Solution</button>
        </div>
    </div>
    <div id="results"></div>
</div>

<script>
const START = "Snelliusstraat 12, Dordrecht";
// Coordinates for geographic clustering (approx for Netherlands region)
const clientData = {
    "SHI001": {a: "Dordrecht Voltastraat 6A", lat: 51.80, lng: 4.65}, "SHI038": {a: "Dordrecht Voltastraat 6A", lat: 51.80, lng: 4.65},
    "FUJ001": {a: "ROTTERDAM Kortenoord 2-8", lat: 51.88, lng: 4.45}, "MAA002": {a: "HOOGVLIET Klompenmakerstraat 26", lat: 51.86, lng: 4.35},
    "WRI001": {a: "ROTTERDAM Bunschotenweg 58", lat: 51.89, lng: 4.41}, "KLO118": {a: "Rotterdam Rhoneweg 68", lat: 51.95, lng: 4.40},
    "MSC001": {a: "ROTTERDAM Columbusstraat 26-28", lat: 51.88, lng: 4.42}, "HUL001": {a: "ANTWERPEN Bredastraat 139", lat: 51.23, lng: 4.43}
};

let stops = [];
const dropZone = document.getElementById("dropZone");
const status = document.getElementById("status");
const calcBtn = document.getElementById("calcBtn");

dropZone.onclick = () => { let i = document.createElement("input"); i.type="file"; i.onchange=e=>handleFile(e.target.files[0]); i.click(); };
dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add("active"); };
dropZone.ondrop = e => { e.preventDefault(); dropZone.classList.remove("active"); handleFile(e.dataTransfer.files[0]); };

function handleFile(file) {
    if(!file) return;
    const r = new FileReader();
    r.onload = e => {
        const wb = XLSX.read(new Uint8Array(e.target.result), {type:"array"});
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1, defval:""});
        let hIdx = rows.findIndex(row => row.includes("Customer"));
        const heads = rows[hIdx];
        const data = rows.slice(hIdx + 1);
        const col = { cust: heads.indexOf("Customer"), trans: heads.indexOf("Transport no."), m3: heads.indexOf("Expected mtr3") };
        
        let g = {};
        data.forEach(row => {
            const id = row[col.cust]; if(!id) return;
            const tNo = String(row[col.trans]).replace(/,/g, "");
            const vol = parseFloat(String(row[col.m3]).replace(",", ".")) || 0;
            if(!g[id]) {
                const geo = clientData[id] || {lat: 51.9, lng: 4.5}; // Default Rotterdam if unknown
                g[id] = { id, items: [], totalVol: 0, lat: geo.lat, lng: geo.lng, addr: geo.a || id };
            }
            g[id].items.push({ no: tNo, vol: vol });
            g[id].totalVol += vol;
        });
        stops = Object.values(g);
        status.innerText = `${stops.length} Locations Ready.`;
        calcBtn.disabled = false;
    };
    r.readAsArrayBuffer(file);
}

calcBtn.onclick = () => {
    // 1. Geographic Clustering by Longitude (West to East)
    stops.sort((a,b) => a.lng - b.lng);
    let trucks = [{id:1, stops:[], vol:0}, {id:2, stops:[], vol:0}, {id:3, stops:[], vol:0}];
    
    // Initial assignment
    stops.forEach((s, idx) => {
        let tIdx = Math.min(2, Math.floor((idx / stops.length) * 3));
        trucks[tIdx].stops.push({...s, items: [...s.items], currentVol: s.totalVol});
        trucks[tIdx].vol += s.totalVol;
    });

    // 2. Proactive Balancing (The "Fairness" Pass)
    for(let i=0; i<30; i++) {
        trucks.sort((a,b) => b.vol - a.vol);
        let h = trucks[0], l = trucks[2];
        if(h.vol - l.vol < 0.3) break;

        // Find a stop on the "boundary" to move or split
        let candidate = h.stops.find(s => s.items.length > 1) || h.stops[h.stops.length-1];
        if(!candidate) break;

        let item = candidate.items.pop();
        candidate.currentVol -= item.vol;
        h.vol -= item.vol;
        if(candidate.currentVol <= 0) h.stops = h.stops.filter(x => x !== candidate);

        let targetStop = l.stops.find(x => x.id === candidate.id);
        if(targetStop) {
            targetStop.items.push(item);
            targetStop.currentVol += item.vol;
        } else {
            l.stops.push({...candidate, items: [item], currentVol: item.vol});
        }
        l.vol += item.vol;
    }
    render(trucks);
};

function render(trucks) {
    const res = document.getElementById("results");
    res.innerHTML = "";
    trucks.sort((a,b) => a.id - b.id).forEach(t => {
        const card = document.createElement("div");
        card.className = "truck-card";
        card.innerHTML = `
            <div class="t-header"><h2>TRUCK ${t.id}</h2></div>
            <div id="map-${t.id}" class="map-box"></div>
            <div class="stats">
                <div><span class="s-label">Load</span><span class="s-val">${t.vol.toFixed(2)} m³</span></div>
                <div><span class="s-label">Stops</span><span class="s-val">${t.stops.length}</span></div>
                <div><span class="s-label">Distance</span><span class="s-val" id="dist-${t.id}">--</span></div>
                <div><span class="s-label">Travel Time</span><span class="s-val" id="time-${t.id}">--</span></div>
            </div>
            <div class="stop-list">${t.stops.map(s => `
                <div class="stop-item">
                    <div><div class="stop-name">${s.id}</div><div style="font-size:0.7rem;color:var(--text-light)">${s.items.map(i=>i.no).join(", ")}</div></div>
                    <div style="font-weight:800">${s.currentVol.toFixed(2)}</div>
                </div>`).join("")}
            </div>
            <div class="copy-area"><button class="btn-copy" id="btn-${t.id}" onclick="copyClip(${t.id})">Copy Transport List</button></div>
        `;
        res.appendChild(card);
        initMap(t);
    });
    window.current = trucks;
}

function initMap(t) {
    if(typeof google === "undefined") return;
    const map = new google.maps.Map(document.getElementById(`map-${t.id}`), { zoom: 9, center: {lat: 51.8, lng: 4.5}, disableDefaultUI: true });
    const ds = new google.maps.DirectionsService(), dr = new google.maps.DirectionsRenderer({map});
    const pts = t.stops.map(s => ({ location: s.addr, stopover: true }));
    if(pts.length > 0) {
        ds.route({ origin: START, destination: START, waypoints: pts, optimizeWaypoints: true, travelMode: 'DRIVING' }, (res, stat) => {
            if(stat === 'OK') {
                dr.setDirections(res);
                let d = 0, tt = 0;
                res.routes[0].legs.forEach(l => { d += l.distance.value; tt += l.duration.value; });
                document.getElementById(`dist-${t.id}`).innerText = (d/1000).toFixed(1) + " km";
                document.getElementById(`time-${t.id}`).innerText = Math.floor(tt/3600) + "h " + Math.floor((tt%3600)/60) + "m";
            }
        });
    }
}

async function copyClip(id) {
    const t = window.current.find(x => x.id === id);
    const nos = t.stops.flatMap(s => s.items.map(i => i.no)).join(";");
    await navigator.clipboard.writeText(nos);
    const b = document.getElementById(`btn-${id}`);
    b.innerText = "✓ Copied!"; b.classList.add("success");
    setTimeout(() => { b.innerText = "Copy Transport List"; b.classList.remove("success"); }, 2000);
}
</script>
</body>
</html>