<!DOCTYPE html>
<html lang="en">
<head>
<meta name="robots" content="noindex, nofollow, noarchive">
<meta charset="UTF-8">
<title>B&S â€“ Pallet Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial, sans-serif; padding: 20px; }
h1 { text-align: center; color: #007bff; }
.drop-zone {
    max-width: 600px; margin: 20px auto;
    border: 2px dashed #007bff; border-radius: 8px;
    padding: 40px; text-align: center; cursor: pointer;
}
.drop-zone.dragover { background-color: #f0f8ff; }
.buttons { text-align: center; margin: 20px 0; }
.buttons button { margin: 0 10px; padding: 10px 20px; cursor: pointer; }
.transport {
    border: 1px solid #ddd; border-radius: 6px;
    padding: 15px; margin-bottom: 20px;
}
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
th { background-color: #007bff; color: white; }
.status { text-align: center; font-weight: bold; margin-top: 15px; }
.sump-btn { margin-top: 10px; }
</style>
</head>

<body>

<h1>Pallet Calculator/Aanmelden</h1>

<div class="drop-zone" id="dropZone">
    Drag & drop Excel or CSV file here<br>
    or click to select
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" hidden>
</div>

<div class="buttons">
    <button onclick="filterMeeder()">Meeder</button>
    <button onclick="filterSump()">Sump</button>
</div>

<div class="status" id="status"></div>
<div id="output"></div>

<script>
let allTransports = {};
let currentView = "all";

const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
const status = document.getElementById("status");
const output = document.getElementById("output");

dropZone.onclick = () => fileInput.click();
dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add("dragover"); };
dropZone.ondragleave = () => dropZone.classList.remove("dragover");
dropZone.ondrop = e => {
    e.preventDefault(); dropZone.classList.remove("dragover");
    handleFile(e.dataTransfer.files[0]);
};
fileInput.onchange = e => handleFile(e.target.files[0]);

function handleFile(file) {
    if (!file) return;
    status.textContent = "Processing file...";
    const reader = new FileReader();
    reader.onload = e => {
        const wb = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        processData(rows);
    };
    reader.readAsArrayBuffer(file);
}

function parseEuroNumber(v) {
    if (typeof v === "number") return v;
    return parseFloat(String(v).replace(/\./g, "").replace(",", ".")) || 0;
}

function parseExcelDate(v) {
    if (typeof v === "number") {
        const d = XLSX.SSF.parse_date_code(v);
        return `${String(d.d).padStart(2,"0")}-${String(d.m).padStart(2,"0")}-${d.y}`;
    }
    return v || "";
}

function shipmentType(id) {
    if (id === "GTC") return "Dry";
    if (id === "GTC/K") return "Chilled";
    if (id === "GTC/V") return "Frozen";
    if (id === "NO9/GTC/V") return "VE";
    return null;
}

function processData(rows) {
    const headers = rows[1];
    const data = rows.slice(2);

    const idx = {
        shipment: headers.indexOf("Shipment identifier"),
        transport: headers.indexOf("Transport no."),
        date: headers.indexOf("Delivery date customer"),
        destination: headers.indexOf("Destination"),
        kg: headers.indexOf("Expected kg gross"),
        m3: headers.indexOf("Expected mtr3")
    };

    allTransports = {};

    data.forEach(r => {
        const no = r[idx.transport];
        const type = shipmentType(r[idx.shipment]);
        if (!no || !type) return;

        if (!allTransports[no]) {
            allTransports[no] = {
                destination: r[idx.destination],
                deliveryDate: parseExcelDate(r[idx.date]),
                shipments: {}
            };
        }

        if (!allTransports[no].shipments[type]) {
            allTransports[no].shipments[type] = { kg: 0, m3: 0 };
        }

        allTransports[no].shipments[type].kg += parseEuroNumber(r[idx.kg]);
        allTransports[no].shipments[type].m3 += parseEuroNumber(r[idx.m3]);
    });

    currentView = "all";
    render(allTransports);
    status.textContent = "Calculation complete";
}

function render(transports) {
    output.innerHTML = "";

    Object.entries(transports).forEach(([no, t]) => {
        let sumpButton = "";
        if (currentView === "sump" && t.destination.toLowerCase().includes("sump")) {
            sumpButton = `
<div class="sump-btn">
<button onclick="exportSumpExcel('${no}')">Send to Sump</button>
</div>`;
        }

        const div = document.createElement("div");
        div.className = "transport";
        div.innerHTML = `
<strong>${no} / ${t.destination} / Delivery customer ${t.deliveryDate}</strong>
${sumpButton}
<table>
<tr><th>Type</th><th>Kg</th><th>Mtr3</th><th>Pallets</th></tr>
${Object.entries(t.shipments).map(([type,v]) => {
    let pallets = Math.round(v.m3 / 1.4);
    if (pallets < 1) pallets = 1;
    return `
<tr>
<td>${type}</td>
<td>${v.kg.toFixed(2)}</td>
<td>${v.m3.toFixed(2)}</td>
<td>${pallets}</td>
</tr>`;
}).join("")}
</table>`;
        output.appendChild(div);
    });
}

function filterMeeder() {
    currentView = "meeder";
    const filtered = {};
    let emailText = `Hi,\n\nWanneer laden? Graag per boot opgeven:\n\n`;

    Object.entries(allTransports).forEach(([no, t]) => {
        if (t.destination.toLowerCase().includes("meeder")) {
            filtered[no] = t;
            emailText += `${no} / ${t.destination} / Delivery customer ${t.deliveryDate}\n`;
            Object.entries(t.shipments).forEach(([type,v]) => {
                let pallets = Math.round(v.m3 / 1.4);
                if (pallets < 1) pallets = 1;
                emailText += `- ${type}: ${v.kg.toFixed(2)} kg / ${pallets} pallets\n`;
            });
            emailText += "\n";
        }
    });

    render(filtered);
    status.textContent = "Meeder transports filtered & email generated";
    window.location.href =
        `mailto:export@europeancruiselogistics.com?body=${encodeURIComponent(emailText)}`;
}

function filterSump() {
    currentView = "sump";
    const filtered = {};
    Object.entries(allTransports).forEach(([no, t]) => {
        if (t.destination.toLowerCase().includes("sump")) {
            filtered[no] = t;
        }
    });
    render(filtered);
    status.textContent = "Sump transports filtered";
}

function exportSumpExcel(transportNo) {
    const t = allTransports[transportNo];
    if (!t) return;

    const rows = [[
        "date of delivery at Sump & Stammer",
        "range of temperature",
        "PO-number",
        "company name",
        "reference",
        "total (gross weight)",
        "T1/EXA",
        "number of pallets"
    ]];

    ["Dry","Chilled","Frozen"].forEach(type => {
        const v = t.shipments[type];
        if (!v) return;

        let pallets = Math.round(v.m3 / 1.4);
        if (pallets < 1) pallets = 1;

        rows.push([
            "",
            type,
            "",
            "B&S",
            "will follow from S&S",
            v.kg,
            "ALL",
            pallets
        ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sump");

    XLSX.writeFile(wb, `SUMP_${transportNo}.xlsx`);
    status.textContent = `Excel file generated for transport ${transportNo}`;
}
</script>

</body>
</html>
